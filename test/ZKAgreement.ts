import { expect } from "chai";
import { ethers } from "hardhat";
import { SignerWithAddress } from "@nomiclabs/hardhat-ethers/signers";
import { ZKAgreement } from "../typechain-types";

describe("ZKAgreement", () => {
  let owner: SignerWithAddress;
  let contract: ZKAgreement;

  before(async () => {
    [owner] = await ethers.getSigners();
    const validAgreementIdFactory = await ethers.getContractFactory(
      "ValidAgreementId"
    );
    const validAgreementId = await validAgreementIdFactory.deploy();
    await validAgreementId.deployed();

    const validAgreementSignatureInsertFactory =
      await ethers.getContractFactory("ValidAgreementSignatureInsert");
    const validAgreementSignatureInsert =
      await validAgreementSignatureInsertFactory.deploy();
    await validAgreementSignatureInsert.deployed();

    const zkAgreementFactory = await ethers.getContractFactory("ZKAgreement", {
      libraries: {
        ValidAgreementId: validAgreementId.address,
        ValidAgreementSignatureInsert: validAgreementSignatureInsert.address,
      },
    });
    contract = await zkAgreementFactory.deploy(ethers.constants.AddressZero);
  });

  it("creates an agreement with valid id", async () => {
    return expect(
      contract.createAgreement({
        agreementId:
          "13941015527571102340410628630818016248458943493630149538961808525202573893520",
        proof: Buffer.from(
          "2a8f220c812bcc7875d8851783fa85d906705f30bf4f7929aea5f03448c77d940d20abea75dc0381d98eff72df0c1989efbc28e4fe53c62148261fccfd6bbc6a0fcb1eed054972d811a3b7654e86249c1b85341585f42190d28df1bfcecef08b11b28baf76c6ecdd571a118a1fd96af90204e7565c23e556523d8a794f3e3bae1bd0e0466f367f37d44859c038423018a7aec1d6e077014054a4190f047a73032b2f261a00c5f45f1d450e15653ad822a8fb296bd5e28c829119967c32f58d200036e09fd3027ddc0f91565e24e4a76ba5b60a7d1a896540de46962345f680152b8e21d9bc0897c85d9c3f81e10c4426e3386a6068fc7b411fd84c053dbf5cc3207713a888b25520cb750e957ed366e88f9eb86a80b87facb199fd79658983da28da9e4ecee49a96190500b1e41124c5931bbe15812c49af2c4548e72dcd761420fb3265bee011b78d3e65fbde442a937d2c99a489390cb9f26185b18f20cc722c6e9ee734de7c1ed9e3ebb57cb226f74d495cc7ee4be6bb1181161992ca2d060c3db1aeb608e8da3743dd80cdaf18d514779405e7c35b7f7a2d781e41cce7fc18027ae230d8eb207a75bd345d4b733380bf2563f78034db7a0a08aa9728082e166642556d2010918000387477bf3d26178b242b934ca2911c86bc974a6e4b3d2019bd1a5e77780d9aab568eef3aa0a717291a288efb66c861769f07a34426d11957222ab0d077d6e2df453660c3782cc821d386f215e9ee32e4d576c3b78a46069f7151f9712f83c0c2811871938bda533547c2b56b7ef9f110fc423eee79602546e4905ca607aa1eb393c2a452135bbdb170321d09cb2535419f0ed8d8de0103baa8d930c411f866a8b0c3a5240af9c548afb966758429703062d42208ddf91d225433c9ff91b7ce42a9a86804fc05e1495456238bdbb2c147f9bc4fea21f22b9bff2681e74bf77b7c2f9b41f80a69f7f4dd89576b90f92f17288a481c070d15a69d81f8a92fbab4fa2e0dfffd41ca4e05d6c89cc80e22c2fd4ac071aa4b7114a84df447f573bdc6fe54f8a9f0ca10ebe63120728123af72e3a89642203d87179e9e150efb33348d07f0610aa5831c5619889a2cc4e9c1c4b4c5a8097b75bb",
          "hex"
        ),
      })
    )
      .to.emit(contract, "CreateAgreement")
      .withArgs(
        owner.address,
        "13941015527571102340410628630818016248458943493630149538961808525202573893520",
        Buffer.from(
          "2a8f220c812bcc7875d8851783fa85d906705f30bf4f7929aea5f03448c77d940d20abea75dc0381d98eff72df0c1989efbc28e4fe53c62148261fccfd6bbc6a0fcb1eed054972d811a3b7654e86249c1b85341585f42190d28df1bfcecef08b11b28baf76c6ecdd571a118a1fd96af90204e7565c23e556523d8a794f3e3bae1bd0e0466f367f37d44859c038423018a7aec1d6e077014054a4190f047a73032b2f261a00c5f45f1d450e15653ad822a8fb296bd5e28c829119967c32f58d200036e09fd3027ddc0f91565e24e4a76ba5b60a7d1a896540de46962345f680152b8e21d9bc0897c85d9c3f81e10c4426e3386a6068fc7b411fd84c053dbf5cc3207713a888b25520cb750e957ed366e88f9eb86a80b87facb199fd79658983da28da9e4ecee49a96190500b1e41124c5931bbe15812c49af2c4548e72dcd761420fb3265bee011b78d3e65fbde442a937d2c99a489390cb9f26185b18f20cc722c6e9ee734de7c1ed9e3ebb57cb226f74d495cc7ee4be6bb1181161992ca2d060c3db1aeb608e8da3743dd80cdaf18d514779405e7c35b7f7a2d781e41cce7fc18027ae230d8eb207a75bd345d4b733380bf2563f78034db7a0a08aa9728082e166642556d2010918000387477bf3d26178b242b934ca2911c86bc974a6e4b3d2019bd1a5e77780d9aab568eef3aa0a717291a288efb66c861769f07a34426d11957222ab0d077d6e2df453660c3782cc821d386f215e9ee32e4d576c3b78a46069f7151f9712f83c0c2811871938bda533547c2b56b7ef9f110fc423eee79602546e4905ca607aa1eb393c2a452135bbdb170321d09cb2535419f0ed8d8de0103baa8d930c411f866a8b0c3a5240af9c548afb966758429703062d42208ddf91d225433c9ff91b7ce42a9a86804fc05e1495456238bdbb2c147f9bc4fea21f22b9bff2681e74bf77b7c2f9b41f80a69f7f4dd89576b90f92f17288a481c070d15a69d81f8a92fbab4fa2e0dfffd41ca4e05d6c89cc80e22c2fd4ac071aa4b7114a84df447f573bdc6fe54f8a9f0ca10ebe63120728123af72e3a89642203d87179e9e150efb33348d07f0610aa5831c5619889a2cc4e9c1c4b4c5a8097b75bb",
          "hex"
        )
      );
  });

  it("fails to create an agreement if it already exists", async () => {
    return expect(
      contract.createAgreement({
        agreementId:
          "13941015527571102340410628630818016248458943493630149538961808525202573893520",
        proof: Buffer.from(
          "2a8f220c812bcc7875d8851783fa85d906705f30bf4f7929aea5f03448c77d940d20abea75dc0381d98eff72df0c1989efbc28e4fe53c62148261fccfd6bbc6a0fcb1eed054972d811a3b7654e86249c1b85341585f42190d28df1bfcecef08b11b28baf76c6ecdd571a118a1fd96af90204e7565c23e556523d8a794f3e3bae1bd0e0466f367f37d44859c038423018a7aec1d6e077014054a4190f047a73032b2f261a00c5f45f1d450e15653ad822a8fb296bd5e28c829119967c32f58d200036e09fd3027ddc0f91565e24e4a76ba5b60a7d1a896540de46962345f680152b8e21d9bc0897c85d9c3f81e10c4426e3386a6068fc7b411fd84c053dbf5cc3207713a888b25520cb750e957ed366e88f9eb86a80b87facb199fd79658983da28da9e4ecee49a96190500b1e41124c5931bbe15812c49af2c4548e72dcd761420fb3265bee011b78d3e65fbde442a937d2c99a489390cb9f26185b18f20cc722c6e9ee734de7c1ed9e3ebb57cb226f74d495cc7ee4be6bb1181161992ca2d060c3db1aeb608e8da3743dd80cdaf18d514779405e7c35b7f7a2d781e41cce7fc18027ae230d8eb207a75bd345d4b733380bf2563f78034db7a0a08aa9728082e166642556d2010918000387477bf3d26178b242b934ca2911c86bc974a6e4b3d2019bd1a5e77780d9aab568eef3aa0a717291a288efb66c861769f07a34426d11957222ab0d077d6e2df453660c3782cc821d386f215e9ee32e4d576c3b78a46069f7151f9712f83c0c2811871938bda533547c2b56b7ef9f110fc423eee79602546e4905ca607aa1eb393c2a452135bbdb170321d09cb2535419f0ed8d8de0103baa8d930c411f866a8b0c3a5240af9c548afb966758429703062d42208ddf91d225433c9ff91b7ce42a9a86804fc05e1495456238bdbb2c147f9bc4fea21f22b9bff2681e74bf77b7c2f9b41f80a69f7f4dd89576b90f92f17288a481c070d15a69d81f8a92fbab4fa2e0dfffd41ca4e05d6c89cc80e22c2fd4ac071aa4b7114a84df447f573bdc6fe54f8a9f0ca10ebe63120728123af72e3a89642203d87179e9e150efb33348d07f0610aa5831c5619889a2cc4e9c1c4b4c5a8097b75bb",
          "hex"
        ),
      })
    ).to.rejectedWith("Agreement exists");
  });

  it("fails to create an agreement with invalid id", async () => {
    return expect(
      contract.createAgreement({
        agreementId:
          "25672289171331961726174349807060979975311854093145864462589715964709036733828",
        proof: Buffer.from(
          "2a8f220c812bcc7875d8851783fa85d906705f30bf4f7929aea5f03448c77d940d20abea75dc0381d98eff72df0c1989efbc28e4fe53c62148261fccfd6bbc6a0fcb1eed054972d811a3b7654e86249c1b85341585f42190d28df1bfcecef08b11b28baf76c6ecdd571a118a1fd96af90204e7565c23e556523d8a794f3e3bae1bd0e0466f367f37d44859c038423018a7aec1d6e077014054a4190f047a73032b2f261a00c5f45f1d450e15653ad822a8fb296bd5e28c829119967c32f58d200036e09fd3027ddc0f91565e24e4a76ba5b60a7d1a896540de46962345f680152b8e21d9bc0897c85d9c3f81e10c4426e3386a6068fc7b411fd84c053dbf5cc3207713a888b25520cb750e957ed366e88f9eb86a80b87facb199fd79658983da28da9e4ecee49a96190500b1e41124c5931bbe15812c49af2c4548e72dcd761420fb3265bee011b78d3e65fbde442a937d2c99a489390cb9f26185b18f20cc722c6e9ee734de7c1ed9e3ebb57cb226f74d495cc7ee4be6bb1181161992ca2d060c3db1aeb608e8da3743dd80cdaf18d514779405e7c35b7f7a2d781e41cce7fc18027ae230d8eb207a75bd345d4b733380bf2563f78034db7a0a08aa9728082e166642556d2010918000387477bf3d26178b242b934ca2911c86bc974a6e4b3d2019bd1a5e77780d9aab568eef3aa0a717291a288efb66c861769f07a34426d11957222ab0d077d6e2df453660c3782cc821d386f215e9ee32e4d576c3b78a46069f7151f9712f83c0c2811871938bda533547c2b56b7ef9f110fc423eee79602546e4905ca607aa1eb393c2a452135bbdb170321d09cb2535419f0ed8d8de0103baa8d930c411f866a8b0c3a5240af9c548afb966758429703062d42208ddf91d225433c9ff91b7ce42a9a86804fc05e1495456238bdbb2c147f9bc4fea21f22b9bff2681e74bf77b7c2f9b41f80a69f7f4dd89576b90f92f17288a481c070d15a69d81f8a92fbab4fa2e0dfffd41ca4e05d6c89cc80e22c2fd4ac071aa4b7114a84df447f573bdc6fe54f8a9f0ca10ebe63120728123af72e3a89642203d87179e9e150efb33348d07f0610aa5831c5619889a2cc4e9c1c4b4c5a8097b75bb",
          "hex"
        ),
      })
    ).to.rejectedWith("Invalid agreement id");
  });

  it("signs an agreement with valid signature", async () => {
    return expect(
      contract.signAgreement({
        agreementId:
          "15672289171331961726174349807060979975311854093145864462589715964709036733829",
        root: "11138567854912611493926693428430420645437166165045302007425203386365416754882",
        proof: Buffer.from(
          "1a07f5b0b24c31e98368d3e4e3eb2ebcfc9044f3eb2772a641562a22699fec0a1266d8df083e3e7e5486bc84f57b92ecf49d5d3e50f72f66bc4e8e58e476a1dc1c7f8b1ea664f4fab38f693a0cad52ad12750baab09b2499e81f134fc7eead212f276ab6773f264d9d53dca3754d778e6db264f26ab1deaded26404fe1d246f226999ad263af408d06e463b43051ec5cfaad836c40a20808c54430f7174da9a3066a2c7189b6b6091a9e97e1467b7fe545532b9efba25e2360b5d5b7d5c3767809f81cd888c89332f5290bbacd22a8ebd154be0ec0c24a5f753116e5566424092cb7371d8337be9420152434a7b26b10e94267393d3bd2a67c1086c398fb3c98302a6f939876966a58b02f1ac5a5efffced6dd303c3e4200599de8d14006e1de2825a65575e0a5c115ddbdaece6300451b424abd04371637033fabab73fd61511d7ec88fce0766056015c60182ec2bb6aa47846d6e14a3bc2f8466c134a90cd32094abfdea210ceba16b1fad6b1e6f0c2ed8bb0d39249a1ba16bda9416a3842f1d9ebf62f3577fb36589e25d8049e54b2de469bd7ea7b08339c67c55f39aba4a2105e7d23932203bf8c0f210f920f5191b4fe909c9188953476bfbc66445759102daa404affe25db356de5cc306d384d47275603f72542f931ef247e393a81d6023bf2f81645aac3ddc347b6fb4a27a7d59f86f832f9199dbe84ac791df94e7517095f52b3fde97e3dfe9788fa93e8462fdbea1af362715f5ace472e70c74fd80a4054fff55ec96441842c2e13107ceae2fa70fb944df895f3363f1688eb89cd0ae5fc9cf740839486c67a3e983d29f249c8ff13d1eedfbc56f535b0d41bf76e0ad6606dc65f3369e3075730a696015e972d43790dc9d8b00a7d53b0ba9cdc6a04d7811dc9dcf44625e18a354a9cd921e0798ff320183b5a4e87a1beb7bbae521b65df4c7f129aa3b63183e3b99c3d1f9cfa235946017ff7d2ab330385421cab1dfd52ea09d078ef3180e53a0ad50de76a6573b6d08af4823d48285905cda2a3189c155d8baa4023c933fa057bc13c6d0d9072e64673a6e596068735df6969141b210584d58eccc930a1cd77c5218bf37ab3cccf93364e49fe7692a02bd11521",
          "hex"
        ),
      })
    )
      .to.emit(contract, "SignAgreement")
      .withArgs(
        "15672289171331961726174349807060979975311854093145864462589715964709036733829",
        "0",
        "11138567854912611493926693428430420645437166165045302007425203386365416754882",
        Buffer.from(
          "1a07f5b0b24c31e98368d3e4e3eb2ebcfc9044f3eb2772a641562a22699fec0a1266d8df083e3e7e5486bc84f57b92ecf49d5d3e50f72f66bc4e8e58e476a1dc1c7f8b1ea664f4fab38f693a0cad52ad12750baab09b2499e81f134fc7eead212f276ab6773f264d9d53dca3754d778e6db264f26ab1deaded26404fe1d246f226999ad263af408d06e463b43051ec5cfaad836c40a20808c54430f7174da9a3066a2c7189b6b6091a9e97e1467b7fe545532b9efba25e2360b5d5b7d5c3767809f81cd888c89332f5290bbacd22a8ebd154be0ec0c24a5f753116e5566424092cb7371d8337be9420152434a7b26b10e94267393d3bd2a67c1086c398fb3c98302a6f939876966a58b02f1ac5a5efffced6dd303c3e4200599de8d14006e1de2825a65575e0a5c115ddbdaece6300451b424abd04371637033fabab73fd61511d7ec88fce0766056015c60182ec2bb6aa47846d6e14a3bc2f8466c134a90cd32094abfdea210ceba16b1fad6b1e6f0c2ed8bb0d39249a1ba16bda9416a3842f1d9ebf62f3577fb36589e25d8049e54b2de469bd7ea7b08339c67c55f39aba4a2105e7d23932203bf8c0f210f920f5191b4fe909c9188953476bfbc66445759102daa404affe25db356de5cc306d384d47275603f72542f931ef247e393a81d6023bf2f81645aac3ddc347b6fb4a27a7d59f86f832f9199dbe84ac791df94e7517095f52b3fde97e3dfe9788fa93e8462fdbea1af362715f5ace472e70c74fd80a4054fff55ec96441842c2e13107ceae2fa70fb944df895f3363f1688eb89cd0ae5fc9cf740839486c67a3e983d29f249c8ff13d1eedfbc56f535b0d41bf76e0ad6606dc65f3369e3075730a696015e972d43790dc9d8b00a7d53b0ba9cdc6a04d7811dc9dcf44625e18a354a9cd921e0798ff320183b5a4e87a1beb7bbae521b65df4c7f129aa3b63183e3b99c3d1f9cfa235946017ff7d2ab330385421cab1dfd52ea09d078ef3180e53a0ad50de76a6573b6d08af4823d48285905cda2a3189c155d8baa4023c933fa057bc13c6d0d9072e64673a6e596068735df6969141b210584d58eccc930a1cd77c5218bf37ab3cccf93364e49fe7692a02bd11521",
          "hex"
        )
      );
  });

  it("fails to sign an agreement with invalid signature insert", async () => {
    return expect(
      contract.signAgreement({
        agreementId:
          "15672289171331961726174349807060979975311854093145864462589715964709036733829",
        root: "21138567854912611493926693428430420645437166165045302007425203386365416754882",
        proof: Buffer.from(
          "1a07f5b0b24c31e98368d3e4e3eb2ebcfc9044f3eb2772a641562a22699fec0a1266d8df083e3e7e5486bc84f57b92ecf49d5d3e50f72f66bc4e8e58e476a1dc1c7f8b1ea664f4fab38f693a0cad52ad12750baab09b2499e81f134fc7eead212f276ab6773f264d9d53dca3754d778e6db264f26ab1deaded26404fe1d246f226999ad263af408d06e463b43051ec5cfaad836c40a20808c54430f7174da9a3066a2c7189b6b6091a9e97e1467b7fe545532b9efba25e2360b5d5b7d5c3767809f81cd888c89332f5290bbacd22a8ebd154be0ec0c24a5f753116e5566424092cb7371d8337be9420152434a7b26b10e94267393d3bd2a67c1086c398fb3c98302a6f939876966a58b02f1ac5a5efffced6dd303c3e4200599de8d14006e1de2825a65575e0a5c115ddbdaece6300451b424abd04371637033fabab73fd61511d7ec88fce0766056015c60182ec2bb6aa47846d6e14a3bc2f8466c134a90cd32094abfdea210ceba16b1fad6b1e6f0c2ed8bb0d39249a1ba16bda9416a3842f1d9ebf62f3577fb36589e25d8049e54b2de469bd7ea7b08339c67c55f39aba4a2105e7d23932203bf8c0f210f920f5191b4fe909c9188953476bfbc66445759102daa404affe25db356de5cc306d384d47275603f72542f931ef247e393a81d6023bf2f81645aac3ddc347b6fb4a27a7d59f86f832f9199dbe84ac791df94e7517095f52b3fde97e3dfe9788fa93e8462fdbea1af362715f5ace472e70c74fd80a4054fff55ec96441842c2e13107ceae2fa70fb944df895f3363f1688eb89cd0ae5fc9cf740839486c67a3e983d29f249c8ff13d1eedfbc56f535b0d41bf76e0ad6606dc65f3369e3075730a696015e972d43790dc9d8b00a7d53b0ba9cdc6a04d7811dc9dcf44625e18a354a9cd921e0798ff320183b5a4e87a1beb7bbae521b65df4c7f129aa3b63183e3b99c3d1f9cfa235946017ff7d2ab330385421cab1dfd52ea09d078ef3180e53a0ad50de76a6573b6d08af4823d48285905cda2a3189c155d8baa4023c933fa057bc13c6d0d9072e64673a6e596068735df6969141b210584d58eccc930a1cd77c5218bf37ab3cccf93364e49fe7692a02bd11521",
          "hex"
        ),
      })
    ).to.rejectedWith("Invalid signature insert");
  });
});
